<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
<title>Programme Force ‚Äî App</title>
<meta name="theme-color" content="#020617">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icons/icon-192.png">
<link rel="apple-touch-icon-precomposed" href="icons/icon-192.png">
<link rel="icon" type="image/png" href="icons/icon-192.png">
<meta name="apple-mobile-web-app-title" content="Force">

</head>
<body>

<div id="debug"></div>

<!-- small auth pill (doesn't change session list layout) -->

  <span id="loginUser">‚Äî</span>
  <button id="logoutBtn" type="button">D√©connexion</button>
</div>

<!-- HOME -->
<section id="home" class="view show home">
  <h1>Programme Force</h1>
  <p>Choisis ta s√©ance. Ensuite : √©chauffement ‚Üí travail ‚Üí repos (mode coach possible).</p>
  <div id="sessionsList" class="grid"></div>
</section>

<!-- WORKOUT -->
<section id="workout" class="view">
  <div class="app">
    <div class="topRow">
      <button class="backBtn" id="backBtn" type="button" aria-label="Retour">‚Üê</button>
      <div class="h1" id="title">‚Äî</div>
      <label class="coachSwitch" title="Mode coach">
        <input type="checkbox" id="coachToggle" />
        <span></span>
      </label>
    </div>
    <div class="meta" id="meta">‚Äî</div>

    <div class="pills">
      <span class="pill accent" id="phasePill">‚Äî</span>
      <span class="pill" id="setPill">‚Äî</span>
      <span class="pill ok" id="coachPill">Coach : OFF</span>
    </div>

    <div id="media" class="media one">
      <img id="gifA" alt="Exercice" />
      <img id="gifB" alt="Superset" style="display:none" />
      <div id="nextOverlay" class="nextOverlay">
        <div class="box">
          <div class="label">EXERCICE SUIVANT</div>
          <div class="name" id="nextName">‚Äî</div>
        </div>
      </div>

      <!-- Bouton infos (Comment faire / Erreurs) -->
      <button id="infoBtn" class="infoBtn" type="button" aria-label="Infos exercice">i</button>

      <!-- Overlay infos exercice -->
      <div id="infoOverlay" class="infoOverlay" role="dialog" aria-modal="true" aria-label="Infos exercice">
      <div class="infoPanel">
      <div class="infoHeader">
      <div class="infoTitle">Infos exercice</div>
      <button id="infoClose" class="infoClose" type="button" aria-label="Fermer">‚úï</button>
      </div>
      <div class="infoBody">
      <div class="section" id="howtoBox">
      <h3>Comment faire</h3>
      <ul id="steps"></ul>
      </div>
      <div class="section" id="mistakesBox">
      <h3>Erreurs √† √©viter</h3>
      <ul id="mistakes"></ul>
      </div>
      </div>
    </div></div>
    </div>

    <div class="section">
      <div class="row">
        <h3 style="margin:0">√Ä faire</h3>
        <div class="dots" id="dots"></div>
      </div>
      <div id="todo" style="font-weight:900;margin-top:6px">‚Äî</div>
      <div class="small" id="desc" style="margin-top:6px">‚Äî</div>
      <div class="pills" style="justify-content:flex-start;margin-top:10px">
        <span class="pill accent" id="muscle">‚Äî</span>
        <span class="pill" id="restPill">Repos: ‚Äî</span>
      </div>
    </div>

    <div class="timerBox">
      <div class="clock" id="clock">00:45</div>
</div>

    <div class="section" id="historyBox">
      <div class="historyTop">
        <div>
          <div style="font-weight:900">Historique de charge</div>
          <div class="small">Ex : <b>22</b> ou <b>2√ó22</b> ‚Ä¢ sauvegard√© sur cet appareil</div>
        </div>
        <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
          <input id="weightInput" type="text" placeholder="Charge" />
          <button class="btnOk" id="saveWeightBtn">OK</button>
          <button class="btnDanger" id="clearWeightBtn">Effacer</button>
        </div>
      </div>
      <div style="overflow:auto;max-height:180px">
        <table>
          <thead><tr><th>Date</th><th>Charge</th></tr></thead>
          <tbody id="historyBody"></tbody>
        </table>
      </div>
    </div>

  </div>

  <div class="footer">
    <div class="transport">
      <button class="tbtn" id="prevBtn" type="button" aria-label="Pr√©c√©dent"><svg viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M11 5L3 12l8 7V5zm10 0L13 12l8 7V5z"/></svg></button>
      <button class="tbtn primary" id="startPause" type="button" aria-label="Start / Pause"><span id="startPauseIcon"><svg viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M8 5v14l11-7z"/></svg></span></button>
      <button class="tbtn" id="nextBtn" type="button" aria-label="Suivant"><svg viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M3 5v14l8-7-8-7zm10 0v14l8-7-8-7z"/></svg></button>
    </div>
  </div>
</section>

<!-- Login overlay -->

  <div id="loginCard">
    <h2>Connexion</h2>
    <p>Connecte-toi pour charger ton pack de s√©ances (Firestore ‚Üí users/{uid}/profile/config).</p>
    <div class="row">
      <input id="loginEmail" type="email" autocomplete="username" placeholder="Email">
      <input id="loginPass" type="password" autocomplete="current-password" placeholder="Mot de passe">
    </div>
    <div class="row">
      <button id="loginBtn" type="button">Se connecter</button>
    </div>
    <div class="msg" id="loginMsg"></div>
  </div>
</div>

<!-- KEEP: images mapping -->
<script src="images.js"></script>

<!-- NEW: Firebase Option B loader (doesn't change sessions UI/cards) -->
{
      if(document.querySelector(\`script[data-dyn="\${src}"]\`)) return resolve();
      const s = document.createElement("script");
      s.src = src;
      s.async = true;
      s.setAttribute("data-dyn", src);
      s.onload = ()=>resolve();
      s.onerror = ()=>reject(new Error("Impossible de charger: " + src));
      document.head.appendChild(s);
    });
  }

  async function loadUserSessions(uid){
    const ref = doc(db, \`users/\${uid}/profile/config\`);
    const snap = await getDoc(ref);
    if(!snap.exists()) throw new Error("Config manquante: users/{uid}/profile/config");

    const cfg = snap.data() || {};
    const file = cfg.sessionsFile;
    const varName = cfg.sessionsVar;

    if(!file || !varName) throw new Error("Config invalide: sessionsFile/sessionsVar");

    await loadScriptOnce(file);

    const obj = window[varName];
    if(!obj) throw new Error(\`window["\${varName}"] introuvable (sessionsVar incorrect ou fichier).\`);

    // Normalise: ton app lit window.SESSIONS
    window.SESSIONS = obj;

    // Notify the non-module script
    window.dispatchEvent(new Event("pf:sessionsReady"));
  }

  $("loginBtn")?.addEventListener("click", async ()=>{
    const email = $("loginEmail")?.value?.trim();
    const pass  = $("loginPass")?.value || "";
    if(!email || !pass){
      showLogin(true, "Entre email + mot de passe.");
      return;
    }
    try{
      await signInWithEmailAndPassword(auth, email, pass);
    }catch(e){
      showLogin(true, "Connexion impossible: " + (e?.message || e));
    }
  });

  $("logoutBtn")?.addEventListener("click", async ()=>{
    try{ await signOut(auth); }catch(e){}
  });

  onAuthStateChanged(auth, async (user)=>{
    setTopPill(user);

    if(!user){
      showLogin(true, "");
      // ensure sessions cleared
      window.SESSIONS = window.SESSIONS || null;
      return;
    }

    try{
      showLogin(false, "");
      await loadUserSessions(user.uid);
    }catch(e){
      console.error(e);
      // show login overlay as an error surface (still same home layout under it)
      showLogin(true, "Erreur chargement s√©ances:\n" + (e?.message || e));
    }
  });

  // PWA SW (if present)
  if("serviceWorker" in navigator){
    navigator.serviceWorker.register("./service-worker.js").catch(()=>{});
  }
</script>

<script>
/* ========= SAFE REFERENCES ========= */
const IMG = window.IMG || {};
const $ = (id)=>document.getElementById(id);

const PLAY_ICON = `<svg viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M8 5v14l11-7z"/></svg>`;
const PAUSE_ICON = `<svg viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M6 5h4v14H6zM14 5h4v14h-4z"/></svg>`;
function setStartPauseUI(running){
  const icon = $("startPauseIcon");
  if(icon) icon.innerHTML = running ? PAUSE_ICON : PLAY_ICON;
  $("startPause").setAttribute("aria-label", running ? "Pause" : "Start");
}



/* ========= PREVENT ZOOM (iOS Safari) ========= */
(function preventZoom(){
  // Disable pinch-to-zoom gestures (iOS)
  document.addEventListener('gesturestart', (e) => e.preventDefault(), { passive:false });
  document.addEventListener('gesturechange', (e) => e.preventDefault(), { passive:false });
  document.addEventListener('gestureend', (e) => e.preventDefault(), { passive:false });

  // Disable double-tap to zoom (common accidental zoom)
  let lastTouchEnd = 0;
  document.addEventListener('touchend', (e) => {
    const now = Date.now();
    if(now - lastTouchEnd <= 300){
      e.preventDefault();
    }
    lastTouchEnd = now;
  }, { passive:false });
})();




/* ========= USER + THEME (Light/Dark) ‚Äî compact, HOME only ========= */
const USER_KEY = "coach_active_user";         // e.g. "moi" / "femme"
const THEME_KEY_PREFIX = "coach_theme_";      // final key: coach_theme_<user>

function getActiveUser(){
  return localStorage.getItem(USER_KEY) || "moi";
}
function setActiveUser(u){
  localStorage.setItem(USER_KEY, u);
  // re-apply theme for that user
  applyTheme(getSavedOrPreferredTheme());
  // refresh small label (if any)
  refreshThemeUIVisibility();
}

function injectThemeCSS(){
  let st = document.getElementById("themeStyle");
  if(!st){
    st = document.createElement("style");
    st.id = "themeStyle";
    document.head.appendChild(st);
  }
  // we only add overrides; your base CSS stays untouched
  st.textContent = `
    :root[data-theme="light"]{
      --bg:#f3f5f8;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#475569;
      --accent:#2563eb;
      --line:#e2e8f0;
      --ok:#16a34a;
      --warn:#d97706;
      --danger:#dc2626;
    }
    :root[data-theme="light"] .timerBox{ background:#f1f5f9 !important; }
    :root[data-theme="light"] .media img{ background:#f8fafc !important; }
    :root[data-theme="light"] .historyTop input{ background:#fff !important; color: var(--text) !important; }

    /* Compact controls (HOME only) */
    .homeControls{
      position:fixed;
      top: calc(8px + env(safe-area-inset-top));
      right: 8px;
      z-index: 9999;
      display:flex;
      gap:6px;
      align-items:center;
      pointer-events:auto;
    }
    .hcBtn{
      width: 30px; height: 30px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,.22);
      background: rgba(2,6,23,.55);
      color: var(--text);
      display:grid;
      place-items:center;
      font-size: 14px;
      font-weight: 900;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      box-shadow: 0 10px 24px rgba(0,0,0,.22);
      user-select:none;
      cursor:pointer;
    }
    :root[data-theme="light"] .hcBtn{
      background: rgba(255,255,255,.88);
      color: #0f172a;
      border-color: rgba(15,23,42,.14);
      box-shadow: 0 10px 24px rgba(15,23,42,.10);
    }
    :root[data-theme="light"] .primary{ color: #ffffff !important; }
    :root[data-theme="light"] .card button{ color: #ffffff !important; }
  `;
}

function themeKey(){
  return THEME_KEY_PREFIX + getActiveUser();
}

function getSavedOrPreferredTheme(){
  const saved = localStorage.getItem(themeKey());
  if(saved === "dark" || saved === "light") return saved;

  const prefersDark = window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;
  return prefersDark ? "dark" : "light";
}

function applyTheme(theme){
  injectThemeCSS();
  document.documentElement.setAttribute("data-theme", theme);
  localStorage.setItem(themeKey(), theme);

  const meta = document.querySelector('meta[name="theme-color"]');
  if(meta){
    meta.setAttribute("content", theme === "light" ? "#f3f5f8" : "#020617");
  }

  // update button icon if present
  const t = document.getElementById("themeBtn");
  if(t){
    t.textContent = (theme === "light") ? "‚òÄÔ∏é" : "‚òæ";
    t.setAttribute("aria-label", theme === "light" ? "Th√®me clair" : "Th√®me sombre");
  }
}

function toggleTheme(){
  const cur = document.documentElement.getAttribute("data-theme") || "dark";
  applyTheme(cur === "dark" ? "light" : "dark");
}

function mountHomeControls(){
  // create once
  if(document.getElementById("homeControls")) return;

  const wrap = document.createElement("div");
  wrap.id = "homeControls";
  wrap.className = "homeControls";

  const userBtn = document.createElement("div");
  userBtn.id = "userBtn";
  userBtn.className = "hcBtn";
  userBtn.textContent = "üë§";
  userBtn.title = "Utilisateur";
  userBtn.setAttribute("role","button");
  userBtn.setAttribute("tabindex","0");

  const themeBtn = document.createElement("div");
  themeBtn.id = "themeBtn";
  themeBtn.className = "hcBtn";
  themeBtn.textContent = "‚òæ";
  themeBtn.title = "Th√®me";
  themeBtn.setAttribute("role","button");
  themeBtn.setAttribute("tabindex","0");

  const act = (el, fn) => {
    el.addEventListener("click", (e)=>{ e.preventDefault(); fn(); });
    el.addEventListener("keydown", (e)=>{
      if(e.key === "Enter" || e.key === " "){
        e.preventDefault(); fn();
      }
    });
  };

  act(themeBtn, toggleTheme);

  act(userBtn, ()=>{
    const cur = getActiveUser();
    const next = (cur === "moi") ? "femme" : "moi";
    // toggle simple Moi/Femme (tu peux renommer si tu veux)
    setActiveUser(next);
    // petit feedback
    beep(next === "moi" ? 660 : 520, 120);
  });

  wrap.appendChild(userBtn);
  wrap.appendChild(themeBtn);
  document.body.appendChild(wrap);
}

function refreshThemeUIVisibility(){
  const controls = document.getElementById("homeControls");
  if(!controls) return;

  // show only when HOME is visible
  const homeVisible = $("home").classList.contains("show");
  controls.style.display = homeVisible ? "flex" : "none";
}
/* ========= STATE ========= */
let sessionKey = null;
let session = null;
let warmup = [];
let work = [];

let phase = "warmup";   // warmup | work | rest
let wIndex = 0;         // warmup index
let exIndex = 0;        // exercise index
let setIndex = 1;       // 1..sets

let remaining = 45;
let timer = null;
let running = false;

let coachMode = true;
let coachHold = false;  // quand on a cliqu√© "Pause" (coach), on n'auto-red√©marre plus

// Overlay infos exercice
/* ========= AUDIO / VOICE ========= */
function beep(freq=880, ms=220){
  try{
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.type='sine';
    o.frequency.value=freq;
    o.connect(g); g.connect(ctx.destination);
    g.gain.setValueAtTime(0.001, ctx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.2, ctx.currentTime + 0.01);
    g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + ms/1000);
    o.start(); o.stop(ctx.currentTime + ms/1000 + 0.02);
  }catch(e){}
}
function speak(text){
  try{
    if(!('speechSynthesis' in window)) return;
    window.speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(text);
    u.lang='fr-FR';
    u.rate=1.02;
    u.pitch=1.0;
    window.speechSynthesis.speak(u);
  }catch(e){}
}
function announcePhaseStart(p){
  if(!coachMode) return;
  if(p === "work") speak("D√©but de l'exercice");
  else if(p === "rest") speak("D√©but du repos");
  else if(p === "warmup") speak("√âchauffement");
}

function openInfo(){
  const ov = $("infoOverlay");
  if(!ov) return;
  if(ov.classList.contains("show")) return;
  ov.classList.add("show");
}

function closeInfo(){
  const ov = $("infoOverlay");
  if(!ov) return;
  ov.classList.remove("show");
}

/* ========= HISTORY (localStorage) ========= */
function keyFor(exId){ return `coach_force_log_${exId}`; }
function loadLog(exId){
  try{ const raw = localStorage.getItem(keyFor(exId)); return raw ? (JSON.parse(raw) || []) : []; }
  catch(e){ return []; }
}
function saveLog(exId, arr){ localStorage.setItem(keyFor(exId), JSON.stringify(arr.slice(0,200))); }
function addEntry(exId, weight){
  const arr = loadLog(exId);
  arr.unshift({ ts: Date.now(), weight: String(weight).trim() });
  saveLog(exId, arr);
  return arr;
}
function lastWeightFor(exId){ const l = loadLog(exId); return l.length ? l[0].weight : null; }
function fmtDate(ts){
  const d = new Date(ts);
  const dd = String(d.getDate()).padStart(2,'0');
  const mm = String(d.getMonth()+1).padStart(2,'0');
  const yy = d.getFullYear();
  return `${dd}.${mm}.${yy}`;
}
function renderHistory(exId){
  const body = $("historyBody");
  const log = loadLog(exId).slice(0,10);
  body.innerHTML = "";
  if(!log.length){
    const tr = document.createElement('tr');
    tr.innerHTML = `<td style="color:var(--muted)">Aucune entr√©e</td><td></td>`;
    body.appendChild(tr);
    return;
  }
  log.forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${fmtDate(r.ts)}</td><td><b>${r.weight}</b></td>`;
    body.appendChild(tr);
  });
}

/* ========= HELPERS ========= */
function clamp0(n){ return Math.max(0, Math.round(n||0)); }
function fmtClock(sec){
  sec = clamp0(sec);
  const mm = String(Math.floor(sec/60)).padStart(2,'0');
  const ss = String(sec%60).padStart(2,'0');
  return `${mm}:${ss}`;
}
function setClock(sec){
  remaining = clamp0(sec);
  $("clock").textContent = fmtClock(remaining);
}
function resolveImage(valueOrKey){
  if(!valueOrKey) return "";
  const v = String(valueOrKey);
  // si on te donne d√©j√† un chemin
  if(v.startsWith("images/") || v.startsWith("./images/") || v.startsWith("../images/")) return v;
  // sinon c'est une cl√© de mapping
  return IMG[v] || "";
}
function currentWarmup(){ return warmup[wIndex] || null; }
function currentExercise(){ return work[exIndex] || null; }

function shouldShowNextPreview(){
  // dernier repos de l'exercice courant => setIndex === sets ET il existe un exercice suivant
  if(phase !== "rest") return false;
  const ex = currentExercise();
  if(!ex) return false;
  const sets = Number(ex.sets || 1);
  return (setIndex === sets) && (exIndex < work.length - 1);
}
function nextExercise(){ return (exIndex < work.length - 1) ? work[exIndex+1] : null; }

function renderDots(sets){
  const box = $("dots");
  box.innerHTML = "";
  for(let i=1;i<=sets;i++){
    const s = document.createElement('span');
    s.className = "dot" + (i < setIndex ? " on" : (i === setIndex ? " cur" : ""));
    box.appendChild(s);
  }
}

/* ========= TIMER ========= */
function stopTimer(){
  running = false;
  if(timer){ clearInterval(timer); timer = null; }
  setStartPauseUI(false);
}
function startTimer(){
  if(running) return;
  running = true;
  setStartPauseUI(true);
  timer = setInterval(()=>{
    remaining -= 1;
    $("clock").textContent = fmtClock(remaining);

    // D√©compte vocal UNIQUEMENT en fin de phase
    if(coachMode && remaining === 3) speak("3");
    if(coachMode && remaining === 2) speak("2");
    if(coachMode && remaining === 1) speak("1");

    if(remaining <= 0){
      stopTimer();
      onTimerDone();
    }
  }, 1000);
}
function autoStartIfCoach(){
  if(coachMode && !coachHold){
    startTimer();
  }
}

/* ========= FLOW (NEXT/PREV) ========= */
function goWarmup(){
  phase = "warmup";
  announcePhaseStart("warmup");
  render();
}
function goWork(){
  phase = "work";
  announcePhaseStart("work");
  const ex = currentExercise();
  if(coachMode && ex && Number(ex.sets||1) === setIndex) speak("Derni√®re s√©rie");
  render();
}
function goRest(){
  phase = "rest";
  announcePhaseStart("rest");
  render();
}

function onTimerDone(){
  // warmup -> next warmup or work
  if(phase === "warmup"){
    if(wIndex < warmup.length - 1){
      wIndex++;
      goWarmup();
      autoStartIfCoach();
      return;
    }
    // warmup fini -> premier exercice
    phase = "work";
    exIndex = 0;
    setIndex = 1;
    goWork();
    autoStartIfCoach();
    return;
  }

  // work timer done -> rest (si besoin) ou exercice suivant / fin
  if(phase === "work"){
    const ex = currentExercise();
    const sets = Number(ex?.sets || 1);
    const hasNextExercise = exIndex < work.length - 1;

    // on met du repos si :
    // - pas derni√®re s√©rie, ou
    // - derni√®re s√©rie mais il reste un exercice apr√®s (repos de transition)
    const needsRest = (setIndex < sets) || (setIndex === sets && hasNextExercise);

    if(needsRest){
      goRest();
      autoStartIfCoach();
      return;
    }

    // fin du dernier exo (dernier set) -> retour menu
    showHome();
    return;
  }

  // rest done -> soit prochaine s√©rie du m√™me exo, soit exercice suivant
  if(phase === "rest"){
    const ex = currentExercise();
    const sets = Number(ex?.sets || 1);

    if(setIndex < sets){
      setIndex++;
      goWork();
      autoStartIfCoach();
      return;
    }

    // fin de l'exo -> next exo
    if(exIndex < work.length - 1){
      exIndex++;
      setIndex = 1;
      goWork();
      autoStartIfCoach();
      return;
    }

    // fin de s√©ance
    showHome();
  }
}

function nextManual(){
  // "Suivant (s√©rie)" : avance selon phase et logique de s√©ance (comme un coach)
  stopTimer(); // on stoppe net, puis on avance
  if(coachMode) coachHold = true; // en mode coach, un clic manuel = on met hold
  onTimerDone();
}
function prevManual(){
  stopTimer();
  if(phase === "warmup"){
    wIndex = Math.max(0, wIndex - 1);
    render();
    return;
  }
  if(phase === "rest"){
    // revenir au work du m√™me set
    phase = "work";
    render();
    return;
  }
  // phase work
  if(setIndex > 1){
    setIndex--;
    render();
    return;
  }
  if(exIndex > 0){
    exIndex--;
    const ex = currentExercise();
    setIndex = Number(ex?.sets || 1);
    render();
    return;
  }
}

/* ========= UI ========= */
function showHome(){
  stopTimer();
  coachHold = false;
  phase = "warmup";
  wIndex = 0; exIndex = 0; setIndex = 1;
  $("home").classList.add("show");
  $("workout").classList.remove("show");
  refreshThemeUIVisibility();
}
function showWorkout(){
  $("home").classList.remove("show");
  $("workout").classList.add("show");
  refreshThemeUIVisibility();
}

function render(){
  const overlay = $("nextOverlay");
  overlay.classList.remove("show");
  $("nextName").textContent = "‚Äî";

  // Coach pill
  $("coachPill").textContent = `Coach : ${coachMode ? "ON" : "OFF"}`;
  $("coachPill").className = "pill " + (coachMode ? "ok" : "ok");

  // Phase pill
  if(phase === "warmup") $("phasePill").textContent = "√âchauffement";
  if(phase === "work") $("phasePill").textContent = "Travail";
  if(phase === "rest") $("phasePill").textContent = "Repos";

  // Hide top controls during work (keep title visible)
  document.documentElement.classList.toggle("phase-work", phase === "work");

  // Content
  let title = "‚Äî";
  let meta = "‚Äî";
  let todo = "‚Äî";
  let desc = "‚Äî";
  let muscle = "‚Äî";
  let restSec = 60;
  let workSec = 45;
  let sets = 0;

  // Images
  let imgA = "";
  let imgB = "";

  if(phase === "warmup"){
    const w = currentWarmup();
    if(typeof w === "string"){
      title = w;
      meta = "√âchauffement";
      todo = "45 s";
      desc = "Pr√©pare le mouvement, amplitude contr√¥l√©e, respiration."
      muscle = "‚Äî";
      sets = 0;
      workSec = 45;
      restSec = 0;
      imgA = "";
    } else if(w){
      title = w.name || "√âchauffement";
      meta = "√âchauffement";
      todo = w.todo || (w.seconds ? `${w.seconds}s` : "45 s");
      desc = w.desc || "";
      muscle = w.muscle || "‚Äî";
      sets = 0;
      workSec = w.seconds || w.work || 45;
      restSec = 0;
      imgA = resolveImage(w.icon);
    }
    $("setPill").textContent = `√âchauffement ${wIndex+1}/${warmup.length || 1}`;
    renderDots(0);
  }

  if(phase === "work" || phase === "rest"){
    const ex = currentExercise();
    if(ex){
      title = ex.name || "Exercice";
      meta = phase === "rest" ? "Repos" : "Exercice";
      muscle = ex.muscle || "‚Äî";
      sets = Number(ex.sets || 1);
      restSec = Number(ex.rest || 60);
      workSec = (ex.type === "time") ? Number(ex.seconds || 40) : 40;

      todo = (phase === "rest")
        ? `Repos ${restSec}s`
        : `${sets} √ó ${ex.reps || "‚Äî"}`;

      desc = ex.desc || "‚Äî";

      // images
      if(ex.images && (ex.images.a || ex.images.b)){
        imgA = resolveImage(ex.images.a);
        imgB = resolveImage(ex.images.b) || imgA;
      } else {
        imgA = resolveImage(ex.icon);
        imgB = "";
      }

      $("setPill").textContent = `S√©rie ${setIndex}/${sets}`;
      renderDots(sets);

      // Historique
      const last = lastWeightFor(ex.id);
      $("weightInput").value = last || "";
      renderHistory(ex.id);
    } else {
      $("setPill").textContent = "‚Äî";
      renderDots(0);
    }
  }

  // Preview sur le DERNIER repos avant le prochain exo
  if(shouldShowNextPreview()){
    const nx = nextExercise();
    if(nx){
      overlay.classList.add("show");
      const lw = (nx && nx.id) ? lastWeightFor(nx.id) : null;
      $("nextName").innerHTML = `${(nx.name || "‚Äî")}${lw ? `<div style="margin-top:6px;font-size:12px;color:#cbd5e1;font-weight:800">Derni√®re charge : <span style="color:#fff">${lw}</span></div>` : ""}`;
      const previewImg = (nx.images && nx.images.a) ? resolveImage(nx.images.a) : resolveImage(nx.icon);
      if(previewImg) imgA = previewImg;
    }
  }

  // Write UI
  $("title").textContent = title;
  $("meta").textContent = meta;
  $("todo").textContent = todo;
  $("desc").textContent = desc;
  $("muscle").textContent = muscle;
  $("restPill").textContent = `Repos: ${phase==="warmup" ? "‚Äî" : (restSec + "s")}`;

  // Steps / mistakes
  const ex = currentExercise();
  if(phase === "warmup"){
    $("steps").innerHTML = "";
    $("mistakes").innerHTML = "";
    // pas d'infos en √©chauffement
    $("infoBtn").classList.remove("show");
    closeInfo();
  } else {
    $("steps").innerHTML = (ex?.steps || []).map(s=>`<li>${s}</li>`).join("");
    $("mistakes").innerHTML = (ex?.mistakes || []).map(s=>`<li>${s}</li>`).join("");

    const hasInfo = ((ex?.steps || []).length + (ex?.mistakes || []).length) > 0;
    $("infoBtn").classList.toggle("show", hasInfo);
    if(!hasInfo) closeInfo();
  }

  // Images display
  $("gifA").src = imgA || "";
  if(imgB){
    $("gifB").src = imgB;
    $("gifB").style.display = "block";
    $("media").classList.remove("one");
  } else {
    $("gifB").style.display = "none";
    $("media").classList.add("one");
  }

  // Set timer for current phase
  if(phase === "warmup" || phase === "work"){
    setClock(workSec);
  } else {
    setClock(restSec);
  }

  updateTransportButtons();
}

/* ========= SESSION LIST ========= */
function renderSessions(){
  const box = $("sessionsList");
  box.innerHTML = "";
  const S = window.SESSIONS || {};
  const keys = Object.keys(S);
  if(!keys.length){
    box.innerHTML = `<div class="card"><h2>Aucune s√©ance</h2><div class="meta">sessions.js n'est pas charg√© ou vide.</div></div>`;
    return;
  }
  keys.forEach(k=>{
    const s = S[k];
    const name = s.name || `S√©ance ${k}`;
    const wlen = (s.warmup || []).length;
    const ilen = (s.items || s.exercises || []).length;
    const c = document.createElement("div");
    c.className = "card";
    c.innerHTML = `<h2>${name}</h2><div class="meta">${wlen} √©chauffements ‚Ä¢ ${ilen} exercices</div>`;
    const b = document.createElement("button");
    b.textContent = "D√©marrer";
    b.onclick = ()=>startSession(k);
    c.appendChild(b);
    box.appendChild(c);
  });
}

function startSession(k){
  sessionKey = k;
  session = window.SESSIONS[k];
  warmup = session.warmup || [];
  work = session.items || session.exercises || [];

  phase = warmup.length ? "warmup" : "work";
  wIndex = 0;
  exIndex = 0;
  setIndex = 1;
  coachHold = false;

  showWorkout();
  render();
  autoStartIfCoach();
}

function haptic(ms=10){
  try{
    if(navigator.vibrate) navigator.vibrate(ms);
  }catch(e){}
}
function canPrev(){
  if(phase === "warmup") return wIndex > 0;
  if(phase === "rest") return true;
  if(setIndex > 1) return true;
  if(exIndex > 0) return true;
  return false;
}
function updateTransportButtons(){
  const prev = $("prevBtn");
  if(prev) prev.disabled = !canPrev();
}

/* ========= EVENTS ========= */
$("startPause").onclick = ()=>{
  haptic();
  if(running){
    coachHold = true;
    stopTimer();
  }else{
    coachHold = false;
    startTimer();
  }
};
$("nextBtn").onclick = ()=>{ haptic(); nextManual(); };
$("prevBtn").onclick = ()=>{ haptic(); prevManual(); };
// Switch Mode coach (en haut √† droite)
const coachToggle = $("coachToggle");
function syncCoachUI(){
  if(coachToggle) coachToggle.checked = !!coachMode;
  $("coachPill").textContent = `Coach : ${coachMode ? "ON" : "OFF"}`;
}
if(coachToggle){
  coachToggle.addEventListener("change", ()=>{
  haptic(8);
    coachMode = !!coachToggle.checked;
    coachHold = false;
    syncCoachUI();
    beep(coachMode ? 880 : 440, 160);
    if(coachMode && !running){
      // au basculement, on d√©marre si on est dans workout
      if($("workout").classList.contains("show")) autoStartIfCoach();
    }
  });
}
syncCoachUI();
$("backBtn").onclick = showHome;

$("saveWeightBtn").onclick = ()=>{
  const ex = currentExercise();
  if(!ex || !ex.id) return;
  const v = $("weightInput").value.trim();
  if(!v) return;
  addEntry(ex.id, v);
  renderHistory(ex.id);
  beep(880, 140);
};
$("clearWeightBtn").onclick = ()=>{
  const ex = currentExercise();
  if(!ex || !ex.id) return;
  localStorage.removeItem(keyFor(ex.id));
  renderHistory(ex.id);
  beep(440, 140);
};

window.addEventListener("DOMContentLoaded", ()=>{
  // Theme + user
  mountHomeControls();
  applyTheme(getSavedOrPreferredTheme());
  refreshThemeUIVisibility();

  // Infos exercice overlay
  const infoBtn = $("infoBtn");
  const infoOverlay = $("infoOverlay");
  const infoClose = $("infoClose");
  if(infoBtn) infoBtn.addEventListener("click", (e)=>{ e.preventDefault(); openInfo(); });
  if(infoClose) infoClose.addEventListener("click", (e)=>{ e.preventDefault(); closeInfo(); });
  if(infoOverlay){
    // click sur le fond = fermer
    infoOverlay.addEventListener("click", (e)=>{
      if(e.target === infoOverlay) closeInfo();
    });
  }

  const d = $("debug");
  d.style.display = "none";
  const hasSessions = !!window.SESSIONS;
  const hasImages = !!window.IMG;
  d.textContent = `‚úÖ init\nSESSIONS: ${hasSessions ? Object.keys(window.SESSIONS).length : "absent"}\nIMG keys: ${hasImages ? Object.keys(window.IMG).length : "absent"}`;

  // NEW: wait for sessions loaded via Firebase (Option B)
  const tryRender = ()=>{
    renderSessions();
  };
  if(window.SESSIONS && Object.keys(window.SESSIONS||{}).length){
    tryRender();
  }else{
    // Render after loader dispatches event
    window.addEventListener("pf:sessionsReady", ()=>{
      tryRender();
    }, { once:true });

    // fallback: show empty state after 2s if no event (keeps same UI)
    setTimeout(()=>{
      if(!(window.SESSIONS && Object.keys(window.SESSIONS||{}).length)){
        tryRender();
      }
    }, 2000);
  }
});
</script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAPICbQrWgARovGaebUYYP-WwohxQAYtuw",
  authDomain: "programme-force.firebaseapp.com",
  projectId: "programme-force",
  storageBucket: "programme-force.firebasestorage.app",
  messagingSenderId: "1070910165788",
  appId: "1:1070910165788:web:8212aec95671abfbdb60d9"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

function loadScriptOnce(src){
  return new Promise((resolve, reject)=>{
    if(document.querySelector(`script[data-dyn="${src}"]`)) return resolve();
    const s = document.createElement("script");
    s.src = src;
    s.async = true;
    s.setAttribute("data-dyn", src);
    s.onload = resolve;
    s.onerror = ()=>reject(new Error("Impossible de charger " + src));
    document.head.appendChild(s);
  });
}

async function loadUserSessions(uid){
  const snap = await getDoc(doc(db, `users/${uid}/profile/config`));
  if(!snap.exists()) throw new Error("Config Firestore manquante");
  const { sessionsFile, sessionsVar } = snap.data();
  await loadScriptOnce(sessionsFile);
  if(!window[sessionsVar]) throw new Error("sessionsVar invalide");
  window.SESSIONS = window[sessionsVar];
  window.dispatchEvent(new Event("pf:sessionsReady"));
}

async function promptLogin(){
  const email = prompt("Email Firebase :");
  if(!email) return;
  const pass = prompt("Mot de passe :");
  if(!pass) return;
  await signInWithEmailAndPassword(auth, email, pass);
}

onAuthStateChanged(auth, async (user)=>{
  try{
    if(!user){
      await promptLogin();
      return;
    }
    await loadUserSessions(user.uid);
  }catch(e){
    alert("Erreur chargement s√©ances:\n" + e.message);
  }
});
</script>

</body>
</html>
