<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
<title>Programme Force â€” App</title>
<meta name="theme-color" content="#020617">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icons/icon-192.png">
<link rel="apple-touch-icon-precomposed" href="icons/icon-192.png">
<link rel="icon" type="image/png" href="icons/icon-192.png">
<meta name="apple-mobile-web-app-title" content="Force">
<style>
:root{
  --bg:#020617;--card:#0b1220;--text:#f8fafc;--muted:#94a3b8;--accent:#38bdf8;
  --line:#1e293b;--ok:#22c55e;--warn:#f59e0b;--danger:#ef4444;
  --mono: ui-monospace, Menlo, Consolas, monospace;
}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto;background:var(--bg);color:var(--text);padding-top: env(safe-area-inset-top);}
.view{display:none;min-height:100vh;padding:16px}
.view.show{display:block}
#debug{display:none;padding:10px 12px;background:rgba(34,197,94,.12);border-bottom:1px solid rgba(34,197,94,.25);color:#bbf7d0;font-family:var(--mono);font-size:12px;white-space:pre-wrap}

/* HOME */
.home h1{margin:0;font-size:26px;font-weight:950}
.home p{color:var(--muted);margin:8px 0 14px}
.grid{display:grid;grid-template-columns:1fr;gap:12px}
.card{border:1px solid var(--line);border-radius:16px;padding:14px;background:var(--card)}
.card h2{margin:0;font-size:16px;font-weight:900}
.card .meta{color:var(--muted);font-size:12px;margin-top:6px}
.card button{margin-top:12px;width:100%;padding:14px;border-radius:14px;border:0;font-weight:900;background:var(--accent);color:#020617;cursor:pointer}

/* WORKOUT */
.app{padding-bottom:250px}
.h1{font-size:20px;font-weight:950;margin:6px 0;text-align:center}
.meta{color:var(--muted);font-size:13px;text-align:center}
.pills{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin-top:10px}
.pill{padding:6px 10px;border-radius:999px;border:1px solid rgba(148,163,184,.22);background:rgba(148,163,184,.08);color:var(--muted);font-size:12px}
.pill.accent{border-color:rgba(56,189,248,.35);color:#bae6fd;background:rgba(56,189,248,.08)}
.pill.ok{border-color:rgba(34,197,94,.35);color:#bbf7d0;background:rgba(34,197,94,.08)}
.pill.warn{border-color:rgba(245,158,11,.35);color:#fde68a;background:rgba(245,158,11,.08)}

.media{margin-top:12px;display:grid;grid-template-columns:1fr 1fr;gap:10px;position:relative}
.media.one{grid-template-columns:1fr}
.media img{width:100%;max-height:34vh;object-fit:contain;border-radius:16px;border:1px solid var(--line);background:#01040b}

/* Overlay "exercice suivant" */
.nextOverlay{
  position:absolute; inset:0;
  display:none; align-items:center; justify-content:center; text-align:center;
  border-radius:16px;
  background:linear-gradient(180deg, rgba(2,6,23,.12), rgba(2,6,23,.72));
  pointer-events:none;
}
.nextOverlay.show{display:flex}
.nextOverlay .box{
  border:1px solid rgba(56,189,248,.35);
  background:rgba(2,6,23,.78);
  padding:14px 16px;border-radius:14px;
  max-width:92%;
}
.nextOverlay .label{
  font-size:12px;letter-spacing:.14em;
  color:#7dd3fc;font-weight:950;
}
.nextOverlay .name{
  font-size:18px;font-weight:950;margin-top:6px;line-height:1.2
}

.section{margin-top:12px;border:1px solid var(--line);border-radius:16px;background:var(--card);padding:12px}
.section h3{margin:0 0 8px;font-size:14px;font-weight:900}
.section ul{margin:0;padding-left:18px;font-size:13px;color:#cbd5e1}
.section .row{display:flex;justify-content:space-between;align-items:center;gap:10px}
.small{color:var(--muted);font-size:12px;line-height:1.3}

.dots{display:flex;gap:8px;align-items:center;justify-content:flex-end}
.dot{width:10px;height:10px;border-radius:999px;background:rgba(148,163,184,.25);border:1px solid rgba(148,163,184,.25)}
.dot.on{background:rgba(34,197,94,.9);border-color:rgba(34,197,94,.9)}
.dot.cur{background:rgba(56,189,248,.9);border-color:rgba(56,189,248,.9)}

.timerBox{margin-top:12px;border:1px solid var(--line);border-radius:16px;background:#060c18;padding:12px;text-align:center}
.clock{font-family:var(--mono);font-size:52px;font-weight:950}
.mode{color:var(--muted);font-size:13px;margin-top:4px}

.historyTop{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
.historyTop input{
  width:160px;padding:10px 12px;border-radius:14px;border:1px solid rgba(148,163,184,.22);
  background:#020617;color:var(--text);outline:none;
}
.historyTop button{padding:10px 12px;border-radius:14px;border:0;font-weight:900}
.btnOk{background:rgba(56,189,248,.18);color:#bae6fd}
.btnDanger{background:rgba(239,68,68,.18);color:#fecaca}
table{width:100%;border-collapse:collapse;margin-top:10px;font-size:13px}
th,td{padding:8px 6px;border-bottom:1px solid rgba(148,163,184,.14);text-align:left}
th{color:var(--muted);font-weight:900}

.footer{position:fixed;left:0;right:0;bottom:0;padding:12px;background:rgba(2,6,23,.92);border-top:1px solid var(--line);backdrop-filter: blur(10px)}
.footer .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.footer .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-top:10px}
.footer button{width:100%;padding:16px;border-radius:16px;border:0;font-weight:900}
.primary{background:var(--accent);color:#020617}
.secondary{background:#1e293b;color:var(--text)}
.tertiary{background:rgba(148,163,184,.12);color:var(--text)}

    :root[data-theme="light"] .card button{
      background: var(--accent);
      color: #ffffff;
    }
    :root[data-theme="light"] .secondary{
      background: #e5e7eb;
      color: #0f172a;
    }
    :root[data-theme="light"] .tertiary{
      background: #f1f5f9;
      color: #0f172a;
    }
    :root[data-theme="light"] .themeSwitch label{
      background: #e2e8f0;
    }
    :root[data-theme="light"] .themeSwitch span{
      background: #0f172a;
    }

</style>
</head>
<body>

<div id="debug"></div>

<!-- HOME -->
<section id="home" class="view show home">
  <h1>Programme Force</h1>
  <p>Choisis ta sÃ©ance. Ensuite : Ã©chauffement â†’ travail â†’ repos (mode coach possible).</p>
  <div id="sessionsList" class="grid"></div>
</section>

<!-- WORKOUT -->
<section id="workout" class="view">
  <div class="app">
    <div class="h1" id="title">â€”</div>
    <div class="meta" id="meta">â€”</div>

    <div class="pills">
      <span class="pill accent" id="phasePill">â€”</span>
      <span class="pill" id="setPill">â€”</span>
      <span class="pill ok" id="coachPill">Coach : OFF</span>
    </div>

    <div id="media" class="media one">
      <img id="gifA" alt="Exercice" />
      <img id="gifB" alt="Superset" style="display:none" />
      <div id="nextOverlay" class="nextOverlay">
        <div class="box">
          <div class="label">EXERCICE SUIVANT</div>
          <div class="name" id="nextName">â€”</div>
        </div>
      </div>
    </div>

    <div class="section">
      <div class="row">
        <h3 style="margin:0">Ã€ faire</h3>
        <div class="dots" id="dots"></div>
      </div>
      <div id="todo" style="font-weight:900;margin-top:6px">â€”</div>
      <div class="small" id="desc" style="margin-top:6px">â€”</div>
      <div class="pills" style="justify-content:flex-start;margin-top:10px">
        <span class="pill accent" id="muscle">â€”</span>
        <span class="pill" id="restPill">Repos: â€”</span>
      </div>
    </div>

    <div class="timerBox">
      <div class="clock" id="clock">00:45</div>
      <div class="mode" id="mode">â€”</div>
    </div>

    <div class="section" id="howtoBox">
      <h3>Comment faire</h3>
      <ul id="steps"></ul>
    </div>

    <div class="section" id="mistakesBox">
      <h3>Erreurs Ã  Ã©viter</h3>
      <ul id="mistakes"></ul>
    </div>

    <div class="section" id="historyBox">
      <div class="historyTop">
        <div>
          <div style="font-weight:900">Historique de charge</div>
          <div class="small">Ex : <b>22</b> ou <b>2Ã—22</b> â€¢ sauvegardÃ© sur cet appareil</div>
        </div>
        <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
          <input id="weightInput" type="text" placeholder="Charge" />
          <button class="btnOk" id="saveWeightBtn">OK</button>
          <button class="btnDanger" id="clearWeightBtn">Effacer</button>
        </div>
      </div>
      <div style="overflow:auto;max-height:180px">
        <table>
          <thead><tr><th>Date</th><th>Charge</th></tr></thead>
          <tbody id="historyBody"></tbody>
        </table>
      </div>
    </div>

  </div>

  <div class="footer">
    <div class="grid2">
      <button class="primary" id="startPause">Start</button>
      <button class="secondary" id="nextBtn">Suivant (sÃ©rie)</button>
    </div>
    <div class="grid3">
      <button class="tertiary" id="prevBtn">PrÃ©cÃ©dent</button>
      <button class="tertiary" id="coachBtn">Mode coach</button>
      <button class="tertiary" id="homeBtn">Menu</button>
    </div>
  </div>
</section>

<script src="sessions.js"></script>
<script src="images.js"></script>
<script>
/* ========= SAFE REFERENCES ========= */
const IMG = window.IMG || {};
const $ = (id)=>document.getElementById(id);


/* ========= PREVENT ZOOM (iOS Safari) ========= */
(function preventZoom(){
  // Disable pinch-to-zoom gestures (iOS)
  document.addEventListener('gesturestart', (e) => e.preventDefault(), { passive:false });
  document.addEventListener('gesturechange', (e) => e.preventDefault(), { passive:false });
  document.addEventListener('gestureend', (e) => e.preventDefault(), { passive:false });

  // Disable double-tap to zoom (common accidental zoom)
  let lastTouchEnd = 0;
  document.addEventListener('touchend', (e) => {
    const now = Date.now();
    if(now - lastTouchEnd <= 300){
      e.preventDefault();
    }
    lastTouchEnd = now;
  }, { passive:false });
})();




/* ========= USER + THEME (Light/Dark) â€” compact, HOME only ========= */
const USER_KEY = "coach_active_user";         // e.g. "moi" / "femme"
const THEME_KEY_PREFIX = "coach_theme_";      // final key: coach_theme_<user>

function getActiveUser(){
  return localStorage.getItem(USER_KEY) || "moi";
}
function setActiveUser(u){
  localStorage.setItem(USER_KEY, u);
  // re-apply theme for that user
  applyTheme(getSavedOrPreferredTheme());
  // refresh small label (if any)
  refreshThemeUIVisibility();
}

function injectThemeCSS(){
  let st = document.getElementById("themeStyle");
  if(!st){
    st = document.createElement("style");
    st.id = "themeStyle";
    document.head.appendChild(st);
  }
  // we only add overrides; your base CSS stays untouched
  st.textContent = `
    :root[data-theme="light"]{
      --bg:#f3f5f8;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#475569;
      --accent:#2563eb;
      --line:#e2e8f0;
      --ok:#16a34a;
      --warn:#d97706;
      --danger:#dc2626;
    }
    :root[data-theme="light"] .timerBox{ background:#f1f5f9 !important; }
    :root[data-theme="light"] .media img{ background:#f8fafc !important; }
    :root[data-theme="light"] .footer{ background: rgba(243,245,248,.92) !important; }
    :root[data-theme="light"] .historyTop input{ background:#fff !important; color: var(--text) !important; }

    /* Compact controls (HOME only) */
    .homeControls{
      position:fixed;
      top: calc(8px + env(safe-area-inset-top));
      right: 8px;
      z-index: 9999;
      display:flex;
      gap:6px;
      align-items:center;
      pointer-events:auto;
    }
    .hcBtn{
      width: 30px; height: 30px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,.22);
      background: rgba(2,6,23,.55);
      color: var(--text);
      display:grid;
      place-items:center;
      font-size: 14px;
      font-weight: 900;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      box-shadow: 0 10px 24px rgba(0,0,0,.22);
      user-select:none;
      cursor:pointer;
    }
    :root[data-theme="light"] .hcBtn{
      background: rgba(255,255,255,.88);
      color: #0f172a;
      border-color: rgba(15,23,42,.14);
      box-shadow: 0 10px 24px rgba(15,23,42,.10);
    }
    :root[data-theme="light"] .primary{ color: #ffffff !important; }
    :root[data-theme="light"] .card button{ color: #ffffff !important; }
  `;
}

function themeKey(){
  return THEME_KEY_PREFIX + getActiveUser();
}

function getSavedOrPreferredTheme(){
  const saved = localStorage.getItem(themeKey());
  if(saved === "dark" || saved === "light") return saved;

  const prefersDark = window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;
  return prefersDark ? "dark" : "light";
}

function applyTheme(theme){
  injectThemeCSS();
  document.documentElement.setAttribute("data-theme", theme);
  localStorage.setItem(themeKey(), theme);

  const meta = document.querySelector('meta[name="theme-color"]');
  if(meta){
    meta.setAttribute("content", theme === "light" ? "#f3f5f8" : "#020617");
  }

  // update button icon if present
  const t = document.getElementById("themeBtn");
  if(t){
    t.textContent = (theme === "light") ? "â˜€ï¸Ž" : "â˜¾";
    t.setAttribute("aria-label", theme === "light" ? "ThÃ¨me clair" : "ThÃ¨me sombre");
  }
}

function toggleTheme(){
  const cur = document.documentElement.getAttribute("data-theme") || "dark";
  applyTheme(cur === "dark" ? "light" : "dark");
}

function mountHomeControls(){
  // create once
  if(document.getElementById("homeControls")) return;

  const wrap = document.createElement("div");
  wrap.id = "homeControls";
  wrap.className = "homeControls";

  const userBtn = document.createElement("div");
  userBtn.id = "userBtn";
  userBtn.className = "hcBtn";
  userBtn.textContent = "ðŸ‘¤";
  userBtn.title = "Utilisateur";
  userBtn.setAttribute("role","button");
  userBtn.setAttribute("tabindex","0");

  const themeBtn = document.createElement("div");
  themeBtn.id = "themeBtn";
  themeBtn.className = "hcBtn";
  themeBtn.textContent = "â˜¾";
  themeBtn.title = "ThÃ¨me";
  themeBtn.setAttribute("role","button");
  themeBtn.setAttribute("tabindex","0");

  const act = (el, fn) => {
    el.addEventListener("click", (e)=>{ e.preventDefault(); fn(); });
    el.addEventListener("keydown", (e)=>{
      if(e.key === "Enter" || e.key === " "){
        e.preventDefault(); fn();
      }
    });
  };

  act(themeBtn, toggleTheme);

  act(userBtn, ()=>{
    const cur = getActiveUser();
    const next = (cur === "moi") ? "femme" : "moi";
    // toggle simple Moi/Femme (tu peux renommer si tu veux)
    setActiveUser(next);
    // petit feedback
    beep(next === "moi" ? 660 : 520, 120);
  });

  wrap.appendChild(userBtn);
  wrap.appendChild(themeBtn);
  document.body.appendChild(wrap);
}

function refreshThemeUIVisibility(){
  const controls = document.getElementById("homeControls");
  if(!controls) return;

  // show only when HOME is visible
  const homeVisible = $("home").classList.contains("show");
  controls.style.display = homeVisible ? "flex" : "none";
}
/* ========= STATE ========= */
let sessionKey = null;
let session = null;
let warmup = [];
let work = [];

let phase = "warmup";   // warmup | work | rest
let wIndex = 0;         // warmup index
let exIndex = 0;        // exercise index
let setIndex = 1;       // 1..sets

let remaining = 45;
let timer = null;
let running = false;

let coachMode = true;
let coachHold = false;  // quand on a cliquÃ© "Pause" (coach), on n'auto-redÃ©marre plus

/* ========= AUDIO / VOICE ========= */
function beep(freq=880, ms=220){
  try{
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.type='sine';
    o.frequency.value=freq;
    o.connect(g); g.connect(ctx.destination);
    g.gain.setValueAtTime(0.001, ctx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.2, ctx.currentTime + 0.01);
    g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + ms/1000);
    o.start(); o.stop(ctx.currentTime + ms/1000 + 0.02);
  }catch(e){}
}
function speak(text){
  try{
    if(!('speechSynthesis' in window)) return;
    window.speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(text);
    u.lang='fr-FR';
    u.rate=1.02;
    u.pitch=1.0;
    window.speechSynthesis.speak(u);
  }catch(e){}
}
function announcePhaseStart(p){
  if(!coachMode) return;
  if(p === "work") speak("DÃ©but de l'exercice");
  else if(p === "rest") speak("DÃ©but du repos");
  else if(p === "warmup") speak("Ã‰chauffement");
}

/* ========= HISTORY (localStorage) ========= */
function keyFor(exId){ return `coach_force_log_${exId}`; }
function loadLog(exId){
  try{ const raw = localStorage.getItem(keyFor(exId)); return raw ? (JSON.parse(raw) || []) : []; }
  catch(e){ return []; }
}
function saveLog(exId, arr){ localStorage.setItem(keyFor(exId), JSON.stringify(arr.slice(0,200))); }
function addEntry(exId, weight){
  const arr = loadLog(exId);
  arr.unshift({ ts: Date.now(), weight: String(weight).trim() });
  saveLog(exId, arr);
  return arr;
}
function lastWeightFor(exId){ const l = loadLog(exId); return l.length ? l[0].weight : null; }
function fmtDate(ts){
  const d = new Date(ts);
  const dd = String(d.getDate()).padStart(2,'0');
  const mm = String(d.getMonth()+1).padStart(2,'0');
  const yy = d.getFullYear();
  return `${dd}.${mm}.${yy}`;
}
function renderHistory(exId){
  const body = $("historyBody");
  const log = loadLog(exId).slice(0,10);
  body.innerHTML = "";
  if(!log.length){
    const tr = document.createElement('tr');
    tr.innerHTML = `<td style="color:var(--muted)">Aucune entrÃ©e</td><td></td>`;
    body.appendChild(tr);
    return;
  }
  log.forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${fmtDate(r.ts)}</td><td><b>${r.weight}</b></td>`;
    body.appendChild(tr);
  });
}

/* ========= HELPERS ========= */
function clamp0(n){ return Math.max(0, Math.round(n||0)); }
function fmtClock(sec){
  sec = clamp0(sec);
  const mm = String(Math.floor(sec/60)).padStart(2,'0');
  const ss = String(sec%60).padStart(2,'0');
  return `${mm}:${ss}`;
}
function setClock(sec){
  remaining = clamp0(sec);
  $("clock").textContent = fmtClock(remaining);
}
function resolveImage(valueOrKey){
  if(!valueOrKey) return "";
  const v = String(valueOrKey);
  // si on te donne dÃ©jÃ  un chemin
  if(v.startsWith("images/") || v.startsWith("./images/") || v.startsWith("../images/")) return v;
  // sinon c'est une clÃ© de mapping
  return IMG[v] || "";
}
function currentWarmup(){ return warmup[wIndex] || null; }
function currentExercise(){ return work[exIndex] || null; }

function shouldShowNextPreview(){
  // dernier repos de l'exercice courant => setIndex === sets ET il existe un exercice suivant
  if(phase !== "rest") return false;
  const ex = currentExercise();
  if(!ex) return false;
  const sets = Number(ex.sets || 1);
  return (setIndex === sets) && (exIndex < work.length - 1);
}
function nextExercise(){ return (exIndex < work.length - 1) ? work[exIndex+1] : null; }

function renderDots(sets){
  const box = $("dots");
  box.innerHTML = "";
  for(let i=1;i<=sets;i++){
    const s = document.createElement('span');
    s.className = "dot" + (i < setIndex ? " on" : (i === setIndex ? " cur" : ""));
    box.appendChild(s);
  }
}

/* ========= TIMER ========= */
function stopTimer(){
  running = false;
  if(timer){ clearInterval(timer); timer = null; }
  $("startPause").textContent = "Start";
}
function startTimer(){
  if(running) return;
  running = true;
  $("startPause").textContent = "Pause";
  timer = setInterval(()=>{
    remaining -= 1;
    $("clock").textContent = fmtClock(remaining);

    // DÃ©compte vocal UNIQUEMENT en fin de phase
    if(coachMode && remaining === 3) speak("3");
    if(coachMode && remaining === 2) speak("2");
    if(coachMode && remaining === 1) speak("1");

    if(remaining <= 0){
      stopTimer();
      onTimerDone();
    }
  }, 1000);
}
function autoStartIfCoach(){
  if(coachMode && !coachHold){
    startTimer();
  }
}

/* ========= FLOW (NEXT/PREV) ========= */
function goWarmup(){
  phase = "warmup";
  announcePhaseStart("warmup");
  render();
}
function goWork(){
  phase = "work";
  announcePhaseStart("work");
  const ex = currentExercise();
  if(coachMode && ex && Number(ex.sets||1) === setIndex) speak("DerniÃ¨re sÃ©rie");
  render();
}
function goRest(){
  phase = "rest";
  announcePhaseStart("rest");
  render();
}

function onTimerDone(){
  // warmup -> next warmup or work
  if(phase === "warmup"){
    if(wIndex < warmup.length - 1){
      wIndex++;
      goWarmup();
      autoStartIfCoach();
      return;
    }
    // warmup fini -> premier exercice
    phase = "work";
    exIndex = 0;
    setIndex = 1;
    goWork();
    autoStartIfCoach();
    return;
  }

  // work timer done -> rest (si besoin) ou exercice suivant / fin
  if(phase === "work"){
    const ex = currentExercise();
    const sets = Number(ex?.sets || 1);
    const hasNextExercise = exIndex < work.length - 1;

    // on met du repos si :
    // - pas derniÃ¨re sÃ©rie, ou
    // - derniÃ¨re sÃ©rie mais il reste un exercice aprÃ¨s (repos de transition)
    const needsRest = (setIndex < sets) || (setIndex === sets && hasNextExercise);

    if(needsRest){
      goRest();
      autoStartIfCoach();
      return;
    }

    // fin du dernier exo (dernier set) -> retour menu
    showHome();
    return;
  }

  // rest done -> soit prochaine sÃ©rie du mÃªme exo, soit exercice suivant
  if(phase === "rest"){
    const ex = currentExercise();
    const sets = Number(ex?.sets || 1);

    if(setIndex < sets){
      setIndex++;
      goWork();
      autoStartIfCoach();
      return;
    }

    // fin de l'exo -> next exo
    if(exIndex < work.length - 1){
      exIndex++;
      setIndex = 1;
      goWork();
      autoStartIfCoach();
      return;
    }

    // fin de sÃ©ance
    showHome();
  }
}

function nextManual(){
  // "Suivant (sÃ©rie)" : avance selon phase et logique de sÃ©ance (comme un coach)
  stopTimer(); // on stoppe net, puis on avance
  if(coachMode) coachHold = true; // en mode coach, un clic manuel = on met hold
  onTimerDone();
}
function prevManual(){
  stopTimer();
  if(phase === "warmup"){
    wIndex = Math.max(0, wIndex - 1);
    render();
    return;
  }
  if(phase === "rest"){
    // revenir au work du mÃªme set
    phase = "work";
    render();
    return;
  }
  // phase work
  if(setIndex > 1){
    setIndex--;
    render();
    return;
  }
  if(exIndex > 0){
    exIndex--;
    const ex = currentExercise();
    setIndex = Number(ex?.sets || 1);
    render();
    return;
  }
}

/* ========= UI ========= */
function showHome(){
  stopTimer();
  coachHold = false;
  phase = "warmup";
  wIndex = 0; exIndex = 0; setIndex = 1;
  $("home").classList.add("show");
  $("workout").classList.remove("show");
  refreshThemeUIVisibility();
}
function showWorkout(){
  $("home").classList.remove("show");
  $("workout").classList.add("show");
  refreshThemeUIVisibility();
}

function render(){
  const overlay = $("nextOverlay");
  overlay.classList.remove("show");
  $("nextName").textContent = "â€”";

  // Coach pill
  $("coachPill").textContent = `Coach : ${coachMode ? "ON" : "OFF"}`;
  $("coachPill").className = "pill " + (coachMode ? "ok" : "ok");

  // Phase pill
  if(phase === "warmup") $("phasePill").textContent = "Ã‰chauffement";
  if(phase === "work") $("phasePill").textContent = "Travail";
  if(phase === "rest") $("phasePill").textContent = "Repos";

  // Content
  let title = "â€”";
  let meta = "â€”";
  let todo = "â€”";
  let desc = "â€”";
  let muscle = "â€”";
  let restSec = 60;
  let workSec = 45;
  let sets = 0;

  // Images
  let imgA = "";
  let imgB = "";

  if(phase === "warmup"){
    const w = currentWarmup();
    if(typeof w === "string"){
      title = w;
      meta = "Ã‰chauffement";
      todo = "45 s";
      desc = "PrÃ©pare le mouvement, amplitude contrÃ´lÃ©e, respiration."
      muscle = "â€”";
      sets = 0;
      workSec = 45;
      restSec = 0;
      imgA = "";
    } else if(w){
      title = w.name || "Ã‰chauffement";
      meta = "Ã‰chauffement";
      todo = w.todo || (w.seconds ? `${w.seconds}s` : "45 s");
      desc = w.desc || "";
      muscle = w.muscle || "â€”";
      sets = 0;
      workSec = w.seconds || w.work || 45;
      restSec = 0;
      imgA = resolveImage(w.icon);
    }
    $("setPill").textContent = `Ã‰chauffement ${wIndex+1}/${warmup.length || 1}`;
    renderDots(0);
  }

  if(phase === "work" || phase === "rest"){
    const ex = currentExercise();
    if(ex){
      title = ex.name || "Exercice";
      meta = phase === "rest" ? "Repos" : "Exercice";
      muscle = ex.muscle || "â€”";
      sets = Number(ex.sets || 1);
      restSec = Number(ex.rest || 60);
      workSec = (ex.type === "time") ? Number(ex.seconds || 40) : 40;

      todo = (phase === "rest")
        ? `Repos ${restSec}s`
        : `${sets} Ã— ${ex.reps || "â€”"}`;

      desc = ex.desc || "â€”";

      // images
      if(ex.images && (ex.images.a || ex.images.b)){
        imgA = resolveImage(ex.images.a);
        imgB = resolveImage(ex.images.b) || imgA;
      } else {
        imgA = resolveImage(ex.icon);
        imgB = "";
      }

      $("setPill").textContent = `SÃ©rie ${setIndex}/${sets}`;
      renderDots(sets);

      // Historique
      const last = lastWeightFor(ex.id);
      $("weightInput").value = last || "";
      renderHistory(ex.id);
    } else {
      $("setPill").textContent = "â€”";
      renderDots(0);
    }
  }

  // Preview sur le DERNIER repos avant le prochain exo
  if(shouldShowNextPreview()){
    const nx = nextExercise();
    if(nx){
      overlay.classList.add("show");
      const lw = (nx && nx.id) ? lastWeightFor(nx.id) : null;
      $("nextName").innerHTML = `${(nx.name || "â€”")}${lw ? `<div style="margin-top:6px;font-size:12px;color:#cbd5e1;font-weight:800">DerniÃ¨re charge : <span style="color:#fff">${lw}</span></div>` : ""}`;
      const previewImg = (nx.images && nx.images.a) ? resolveImage(nx.images.a) : resolveImage(nx.icon);
      if(previewImg) imgA = previewImg;
    }
  }

  // Write UI
  $("title").textContent = title;
  $("meta").textContent = meta;
  $("todo").textContent = todo;
  $("desc").textContent = desc;
  $("muscle").textContent = muscle;
  $("restPill").textContent = `Repos: ${phase==="warmup" ? "â€”" : (restSec + "s")}`;

  // Steps / mistakes
  const ex = currentExercise();
  if(phase === "warmup"){
    $("steps").innerHTML = "";
    $("mistakes").innerHTML = "";
  } else {
    $("steps").innerHTML = (ex?.steps || []).map(s=>`<li>${s}</li>`).join("");
    $("mistakes").innerHTML = (ex?.mistakes || []).map(s=>`<li>${s}</li>`).join("");
  }

  // Images display
  $("gifA").src = imgA || "";
  if(imgB){
    $("gifB").src = imgB;
    $("gifB").style.display = "block";
    $("media").classList.remove("one");
  } else {
    $("gifB").style.display = "none";
    $("media").classList.add("one");
  }

  // Set timer for current phase
  if(phase === "warmup" || phase === "work"){
    setClock(workSec);
  } else {
    setClock(restSec);
  }
}

/* ========= SESSION LIST ========= */
function renderSessions(){
  const box = $("sessionsList");
  box.innerHTML = "";
  const S = window.SESSIONS || {};
  const keys = Object.keys(S);
  if(!keys.length){
    box.innerHTML = `<div class="card"><h2>Aucune sÃ©ance</h2><div class="meta">sessions.js n'est pas chargÃ© ou vide.</div></div>`;
    return;
  }
  keys.forEach(k=>{
    const s = S[k];
    const name = s.name || `SÃ©ance ${k}`;
    const wlen = (s.warmup || []).length;
    const ilen = (s.items || s.exercises || []).length;
    const c = document.createElement("div");
    c.className = "card";
    c.innerHTML = `<h2>${name}</h2><div class="meta">${wlen} Ã©chauffements â€¢ ${ilen} exercices</div>`;
    const b = document.createElement("button");
    b.textContent = "DÃ©marrer";
    b.onclick = ()=>startSession(k);
    c.appendChild(b);
    box.appendChild(c);
  });
}

function startSession(k){
  sessionKey = k;
  session = window.SESSIONS[k];
  warmup = session.warmup || [];
  work = session.items || session.exercises || [];

  phase = warmup.length ? "warmup" : "work";
  wIndex = 0;
  exIndex = 0;
  setIndex = 1;
  coachHold = false;

  showWorkout();
  render();
  autoStartIfCoach();
}

/* ========= EVENTS ========= */
$("startPause").onclick = ()=>{
  if(running){
    coachHold = true;
    stopTimer();
  }else{
    coachHold = false;
    startTimer();
  }
};
$("nextBtn").onclick = nextManual;
$("prevBtn").onclick = prevManual;
$("coachBtn").onclick = ()=>{
  coachMode = !coachMode;
  coachHold = false;
  $("coachPill").textContent = `Coach : ${coachMode ? "ON" : "OFF"}`;
  beep(coachMode ? 880 : 440, 160);
  if(coachMode && !running){
    // au basculement, on dÃ©marre si on est dans workout
    if($("workout").classList.contains("show")) autoStartIfCoach();
  }
};
$("homeBtn").onclick = showHome;

$("saveWeightBtn").onclick = ()=>{
  const ex = currentExercise();
  if(!ex || !ex.id) return;
  const v = $("weightInput").value.trim();
  if(!v) return;
  addEntry(ex.id, v);
  renderHistory(ex.id);
  beep(880, 140);
};
$("clearWeightBtn").onclick = ()=>{
  const ex = currentExercise();
  if(!ex || !ex.id) return;
  localStorage.removeItem(keyFor(ex.id));
  renderHistory(ex.id);
  beep(440, 140);
};

window.addEventListener("DOMContentLoaded", ()=>{
  // Theme + user
  mountHomeControls();
  applyTheme(getSavedOrPreferredTheme());
  refreshThemeUIVisibility();
const d = $("debug");
  d.style.display = "none";
  const hasSessions = !!window.SESSIONS;
  const hasImages = !!window.IMG;
  d.textContent = `âœ… init\\nSESSIONS: ${hasSessions ? Object.keys(window.SESSIONS).length : "absent"}\\nIMG keys: ${hasImages ? Object.keys(window.IMG).length : "absent"}`;
  renderSessions();
});
</script>
</body>
</html>
